<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BenjiShop — Panel BrainRot</title>

  <!-- Protection : si pas de token, on renvoie vers /admin/login.html -->
  <script>
    if (localStorage.getItem("admin_token") !== "ok") {
      window.location.href = "/admin/login.html";
    }
  </script>

  <style>
    :root{
      --bg:#02030a;
      --card:#050714;
      --accent:#00f5ff;
      --accent-soft:#00f5ff33;
      --text:#f6f7fb;
      --muted:#a3a7c0;
      --error:#ff4d6a;
      --radius:16px;
      --shadow:0 12px 35px rgba(0,0,0,.7);
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:"Inter","Segoe UI",system-ui,sans-serif;}

    body{
      min-height:100vh;
      background:radial-gradient(circle at 0% 0%, rgba(0,245,255,0.25) 0, transparent 55%),
                 radial-gradient(circle at 100% 100%, rgba(0,245,255,0.18) 0, transparent 55%),
                 #02030a;
      color:var(--text);
    }

    header{
      padding:16px 24px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,0.05);
      backdrop-filter:blur(14px);
      background:linear-gradient(180deg, rgba(2,3,14,0.96), rgba(2,3,14,0.8));
      position:sticky;
      top:0;
      z-index:10;
    }
    .logo{
      font-weight:800;
      letter-spacing:.16em;
      text-transform:uppercase;
      font-size:18px;
      color:var(--muted);
    }
    .logo b{
      color:var(--accent);
      text-shadow:0 0 14px var(--accent-soft);
    }
    .logout{
      font-size:12px;
      color:var(--muted);
      text-decoration:none;
      opacity:.7;
      cursor:pointer;
    }
    .logout:hover{opacity:1;}

    .wrapper{
      max-width:1100px;
      margin:18px auto 40px;
      padding:0 16px 24px;
    }

    .panel{
      background:linear-gradient(145deg, rgba(8,10,24,0.98), rgba(5,7,19,0.98));
      border-radius:var(--radius);
      border:1px solid rgba(0,245,255,0.18);
      box-shadow:var(--shadow);
      padding:22px 20px 20px;
      position:relative;
      overflow:hidden;
    }

    .panel::before{
      content:"";
      position:absolute;
      inset:-30%;
      background:radial-gradient(circle at 0 0, rgba(0,245,255,0.15), transparent 55%);
      opacity:.7;
      pointer-events:none;
    }
    .panel-inner{position:relative;z-index:1;}

    h1{
      font-size:22px;
      margin-bottom:6px;
    }
    h1 span{
      color:var(--accent);
      text-shadow:0 0 12px var(--accent-soft);
    }
    .sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.3fr 1fr;
      gap:18px;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background:rgba(2,3,14,0.85);
      border-radius:14px;
      padding:14px 14px 16px;
      border:1px solid rgba(255,255,255,0.08);
    }

    label{
      display:block;
      font-size:12px;
      margin-bottom:4px;
      color:var(--muted);
    }
    .field{
      margin-bottom:10px;
    }

    input, select{
      width:100%;
      background:#050814;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.16);
      padding:7px 10px;
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    input:focus, select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(0,245,255,0.4);
    }

    input[type="file"]{
      padding:5px 10px;
      background:#050814;
      border-radius:10px;
      cursor:pointer;
    }

    .file-preview{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .file-preview img{
      width:60px;
      height:60px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.16);
    }

    .btn-primary{
      border:0;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0, #00f5ff, #009bff);
      color:#02030a;
      padding:9px 20px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 0 18px rgba(0,245,255,0.7);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin-top:4px;
    }
    .btn-primary:disabled{
      opacity:.5;
      cursor:wait;
      box-shadow:none;
    }

    .status{
      margin-top:8px;
      font-size:12px;
      min-height:16px;
    }
    .status.ok{color:#43ffb1;}
    .status.err{color:var(--error);}

    .list{
      max-height:420px;
      overflow:auto;
      margin-top:6px;
      padding-right:4px;
    }
    .item{
      border-radius:11px;
      border:1px solid rgba(255,255,255,0.12);
      padding:7px 9px;
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:7px;
      background:#050814;
      font-size:12px;
    }
    .item img{
      width:42px;
      height:42px;
      object-fit:cover;
      border-radius:8px;
      flex-shrink:0;
    }
    .item-main{ flex:1; }
    .item-title{
      font-weight:600;
      font-size:12px;
    }
    .item-meta{
      color:var(--muted);
      font-size:11px;
    }
    .item-price{
      font-weight:700;
      color:var(--accent);
      font-size:12px;
    }
    .pill{
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      padding:2px 7px;
      font-size:10px;
      margin-left:4px;
      color:var(--muted);
    }
    .small{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">BENJI<b>SHOP</b></div>
    <!-- Bouton déconnexion -->
    <a class="logout" onclick="logout()">Déconnexion</a>
  </header>

  <main class="wrapper">
    <section class="panel">
      <div class="panel-inner">
        <h1><span>Panel</span> de vente BrainRot</h1>
        <p class="sub">
          Ajoute un nouveau perso, choisis dans quelle <b>catégorie (personnage)</b> de la page d'accueil il apparaît,
          fixe le prix en € et ajoute son image.
        </p>

        <div class="grid">
          <!-- FORMULAIRE -->
          <div class="card">
            <div class="field">
              <label for="name">Nom du BrainRot (variation / skin)</label>
              <input id="name" type="text" placeholder="Ex : Ketchup drip, Skin or, etc.">
            </div>

            <div class="field">
              <label for="category">Personnage / Catégorie d'accueil</label>
              <select id="category"></select>
              <p class="small">
                Mets exactement le même nom que sur la page d’accueil pour que ça tombe dans la bonne catégorie.
              </p>
            </div>

            <div class="field">
              <label for="price">Prix (€)</label>
              <input id="price" type="number" min="0" step="0.01" placeholder="Ex : 15">
            </div>

            <div class="field">
              <label for="image">Image (depuis ton PC)</label>
              <input id="image" type="file" accept="image/*">
              <div class="file-preview" id="filePreview" style="display:none;">
                <img id="previewImg" alt="">
                <span id="previewName"></span>
              </div>
            </div>

            <button class="btn-primary" id="saveBtn">
              Enregistrer le BrainRot
            </button>
            <div class="status" id="status"></div>
            <p class="small">
              Si tu veux aller plus vite, tu peux aussi utiliser ce panel sur ton PC, choisir les images déjà dans ton
              dossier BrainRot, et enchaîner les ajouts très rapidement.
            </p>
          </div>

          <!-- LISTE DES BRAINROT -->
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <div style="font-weight:600;font-size:13px;">BrainRot actuellement en vente</div>
              <div id="count" class="pill">0 items</div>
            </div>
            <div id="list" class="list"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Déconnexion (point 5)
    function logout(){
      localStorage.removeItem("admin_token");
      window.location.href = "/admin/login.html";
    }

    // mêmes personnages que sur la page d’accueil
    const BRAINROT_NAMES = [
      "Burguro and Fryuro",
      "Capitano Moby",
      "Celularcini Viciosini",
      "Chillin Chili",
      "Chipso and Queso",
      "Dragon Cannelloni",
      "Esok Sekolah",
      "Eviledon",
      "Fragrama and Chocrama",
      "Garama and Madundung",
      "Headless Horseman",
      "Ketchuru and Musturu",
      "Ketupat Kepat",
      "La Casa Boo",
      "La Extinct Grande",
      "La Grande Combinasion",
      "La Secret Combinasion",
      "La Spooky Grande",
      "Las Sis",
      "La Supreme Combinasion",
      "La Taco Combinasion",
      "Los 67",
      "Los Bros",
      "Los Primos",
      "Los Puggies",
      "Los Spaghettis",
      "Los Tacoritas",
      "Meowl",
      "Money Money Puggy",
      "Noo My Examine",
      "Nuclearo Dinossauro",
      "Spaghetti Tualetti",
      "Spooky and Pumpky",
      "Strawberry Elephant",
      "Tacorita Bicicleta",
      "Tang Tang Keletang",
      "Tictac Sahur",
      "Tralaledon"
    ].sort((a,b)=>a.localeCompare(b));

    const categorySelect = document.getElementById("category");
    const saveBtn        = document.getElementById("saveBtn");
    const statusEl       = document.getElementById("status");
    const listEl         = document.getElementById("list");
    const countEl        = document.getElementById("count");
    const fileInput      = document.getElementById("image");
    const filePrev       = document.getElementById("filePreview");
    const prevImg        = document.getElementById("previewImg");
    const prevName       = document.getElementById("previewName");

    BRAINROT_NAMES.forEach(n=>{
      const opt=document.createElement("option");
      opt.value=n;
      opt.textContent=n;
      categorySelect.appendChild(opt);
    });

    fileInput.addEventListener("change", ()=>{
      const f=fileInput.files[0];
      if(!f){filePrev.style.display="none";return;}
      filePrev.style.display="flex";
      prevName.textContent=f.name;
      const url=URL.createObjectURL(f);
      prevImg.src=url;
    });

    function setStatus(msg,type){
      statusEl.textContent=msg||"";
      statusEl.className="status" + (type?(" "+type):"");
    }

    function itemCard(p){
      const title=p.title || p.name || "Item";
      const cat=p.category || "Autre";
      const price=(Number(p.price_eur||p.price)||0).toFixed(2).replace(".",",")+"€";

      let img=p.image;
      return `
        <div class="item">
          ${img ? `<img src="${img}" onerror="this.style.display='none'">` : ""}
          <div class="item-main">
            <div class="item-title">${title}</div>
            <div class="item-meta">${cat}</div>
          </div>
          <div class="item-price">${price}</div>
        </div>
      `;
    }

    async function refreshList(){
      try{
        const res = await fetch("/.netlify/functions/products");
        if(!res.ok) throw new Error("HTTP "+res.status);
        const payload = await res.json();
        const rawItems = Array.isArray(payload.items)?payload.items:payload;
        const all = rawItems.filter(Boolean);

        countEl.textContent = all.length + (all.length>1 ? " items" : " item");
        listEl.innerHTML = all.length
          ? all.map(itemCard).join("")
          : "<div class='small'>Aucun BrainRot ajouté pour le moment.</div>";
      }catch(e){
        console.error(e);
        listEl.innerHTML = "<div class='small'>Impossible de charger la liste (fonction Netlify products).</div>";
      }
    }

    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=()=>resolve(reader.result);
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }

    saveBtn.addEventListener("click", async ()=>{
      const name   = document.getElementById("name").value.trim();
      const cat    = categorySelect.value;
      const price  = document.getElementById("price").value.trim();
      const file   = fileInput.files[0];

      if(!name || !cat || !price || !file){
        setStatus("Champs manquants (nom, catégorie, prix, image).", "err");
        return;
      }

      let imageData;
      try{
        imageData = await fileToDataURL(file);
      }catch(e){
        console.error(e);
        setStatus("Erreur lors de la lecture de l'image.", "err");
        return;
      }

      const payload = {
        name,
        category: cat,
        price,
        image: imageData
      };

      saveBtn.disabled=true;
      setStatus("Envoi en cours...", "");

      try{
        const res = await fetch("/.netlify/functions/admin-products", {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const txt = await res.text();
          console.error("HTTP error:", res.status, txt);
          throw new Error("HTTP "+res.status);
        }
        const data = await res.json();
        console.log("Admin save:", data);
        if(!data.ok && !data.success){
          setStatus("Erreur serveur (admin-products).", "err");
        }else{
          setStatus("BrainRot enregistré.", "ok");
          document.getElementById("name").value="";
          document.getElementById("price").value="";
          fileInput.value="";
          filePrev.style.display="none";
          refreshList();
        }
      }catch(e){
        console.error(e);
        setStatus("Erreur serveur. Vérifie la fonction admin-products sur Netlify.", "err");
      }finally{
        saveBtn.disabled=false;
      }
    });

    refreshList();
  </script>
</body>
</html>
