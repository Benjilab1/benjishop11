<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Panel de vente BrainRot — BenjiShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#050712;
      --panel:#0b1020;
      --border:#1c2238;
      --accent:#00f5ff;
      --accent-soft:rgba(0,245,255,.14);
      --text:#eef2ff;
      --muted:#9aa6c0;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      background:radial-gradient(circle at 0 0,#16193b 0,#050712 50%,#020309 100%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      padding:18px;
    }
    .topbar{
      max-width:1100px;
      margin:0 auto 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .logo{
      font-weight:800;
      letter-spacing:.18em;
      font-size:16px;
    }
    .logo span{color:var(--accent);text-shadow:0 0 12px var(--accent-soft);}
    .logout{
      font-size:13px;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.25);
      background:transparent;
      color:var(--muted);
      cursor:pointer;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns: minmax(0,1.05fr) minmax(0,0.95fr);
      gap:18px;
    }
    .panel{
      background:var(--panel);
      border-radius:18px;
      padding:18px 18px 20px;
      border:1px solid var(--border);
      box-shadow:0 18px 40px rgba(0,0,0,.8);
    }
    h2{
      font-size:17px;
      margin-bottom:4px;
    }
    .subtitle{
      font-size:13px;
      color:var(--muted);
      margin-bottom:12px;
    }
    label{
      display:block;
      font-size:13px;
      margin:10px 0 4px;
    }
    input, select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #252b45;
      background:#050713;
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    input:focus, select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    .help{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    .file-row{
      margin-top:8px;
      font-size:13px;
      color:var(--muted);
    }
    button.primary{
      margin-top:16px;
      padding:9px 16px;
      border-radius:999px;
      border:0;
      background:linear-gradient(135deg,#00f5ff,#00aaff);
      color:#02030a;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 0 18px rgba(0,245,255,.7);
    }
    button.primary:disabled{
      opacity:.6;
      cursor:wait;
      box-shadow:none;
    }
    .msg{
      margin-top:10px;
      font-size:13px;
    }
    .msg.error{color:#ff6b6b;}
    .msg.ok{color:#4ade80;}
    .list-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:13px;
      margin-bottom:6px;
    }
    .items{
      margin-top:8px;
      max-height:420px;
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(3,5,15,.85);
      padding:8px;
      font-size:13px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 7px;
      border-radius:10px;
      background:rgba(15,18,40,.9);
      border:1px solid rgba(255,255,255,.06);
      margin-bottom:5px;
    }
    .item span.cat{color:var(--muted);font-size:11px;}
    .item span.price{font-weight:600;color:var(--accent);}
    .empty-text{
      font-size:13px;
      color:var(--muted);
      padding:10px;
    }
    @media(max-width:900px){
      .wrap{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <script>
    // Protection : si pas de token, on renvoie vers login
    if (localStorage.getItem("admin_token") !== "ok") {
      window.location.href = "/admin/login.html";
    }
  </script>

  <div class="topbar">
    <div class="logo">BENJI<span>SHOP</span></div>
    <button class="logout" onclick="logout()">Déconnexion</button>
  </div>

  <div class="wrap">
    <!-- Formulaire ajout -->
    <div class="panel">
      <h2>Panel de vente BrainRot</h2>
      <div class="subtitle">
        Ajoute un nouveau perso, choisis dans quelle <b>catégorie (personnage)</b> de la page d'accueil il apparaît, fixe le prix en € et ajoute son image.
      </div>

      <form id="form">
        <label>Nom du BrainRot (variation / skin)</label>
        <input id="name" required placeholder="Ex: Noa Lonfat">

        <label>Personnage / Catégorie d'accueil</label>
        <select id="category" required>
          <option value="">Choisis le perso…</option>
          <option>Burguro and Fryuro</option>
          <option>Capitano Moby</option>
          <option>Celularcini Viciosini</option>
          <option>Chillin Chili</option>
          <option>Chipso and Queso</option>
          <option>Dragon Cannelloni</option>
          <option>Esok Sekolah</option>
          <option>Eviledon</option>
          <option>Fragrama and Chocrama</option>
          <option>Garama and Madundung</option>
          <option>Headless Horseman</option>
          <option>Ketchuru and Musturu</option>
          <option>Ketupat Kepat</option>
          <option>La Casa Boo</option>
          <option>La Extinct Grande</option>
          <option>La Grande Combinasion</option>
          <option>La Secret Combinasion</option>
          <option>La Spooky Grande</option>
          <option>Las Sis</option>
          <option>La Supreme Combinasion</option>
          <option>Los 67</option>
          <option>Los Bros</option>
          <option>Los Primos</option>
          <option>Los Puggies</option>
          <option>Los Spaghettis</option>
          <option>Los Tacoritas</option>
          <option>Meowl</option>
          <option>Money Money Puggy</option>
          <option>Nuclearo Dinossauro</option>
          <option>Spaghetti Tualetti</option>
          <option>Spooky and Pumpky</option>
          <option>Strawberry Elephant</option>
          <option>Tacorita Bicicleta</option>
          <option>Tang Tang Keletang</option>
          <option>Tictac Sahur</option>
          <option>Tralaledon</option>
        </select>
        <div class="help">
          Mets exactement le même nom que sur la page d'accueil pour que ça tombe dans la bonne catégorie.
        </div>

        <label>Prix (€)</label>
        <input id="price" required type="number" step="0.01" min="0" placeholder="Ex: 12">

        <label>Image (depuis ton PC)</label>
        <input id="file" type="file" accept="image/*" required>
        <div class="file-row" id="fileInfo">Aucune image sélectionnée.</div>

        <button type="submit" class="primary" id="submitBtn">Enregistrer le BrainRot</button>
        <div class="help">
          Si tu veux aller plus vite, tu peux aussi utiliser ce panel sur ton PC, choisir les images déjà dans ton dossier BrainRot, et enchainer les ajouts très rapidement.
        </div>
        <div id="msg" class="msg"></div>
      </form>
    </div>

    <!-- Liste existante -->
    <div class="panel">
      <div class="list-head">
        <div>
          <h2>BrainRot actuellement en vente</h2>
          <div class="subtitle">Liste chargée via la fonction Netlify <code>products</code>.</div>
        </div>
        <div style="font-size:12px;color:var(--muted)"><span id="count">0</span> items</div>
      </div>
      <div id="items" class="items">
        <div class="empty-text">Chargement…</div>
      </div>
    </div>
  </div>

  <script>
    function logout(){
      localStorage.removeItem("admin_token");
      window.location.href = "/admin/login.html";
    }

    const fileInput = document.getElementById("file");
    const fileInfo = document.getElementById("fileInfo");
    const form = document.getElementById("form");
    const msgEl = document.getElementById("msg");
    const submitBtn = document.getElementById("submitBtn");
    const itemsEl = document.getElementById("items");
    const countEl = document.getElementById("count");

    let currentImageDataUrl = "";

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file){
        fileInfo.textContent = "Aucune image sélectionnée.";
        currentImageDataUrl = "";
        return;
      }
      fileInfo.textContent = file.name;

      const reader = new FileReader();
      reader.onload = () => {
        currentImageDataUrl = reader.result; // data URL
      };
      reader.readAsDataURL(file);
    });

    async function loadItems(){
      itemsEl.innerHTML = "<div class='empty-text'>Chargement…</div>";
      countEl.textContent = "0";
      try{
        const res = await fetch("/.netlify/functions/products");
        if (!res.ok){
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json().catch(()=>({}));
        const items = (data.items || []).sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));

        countEl.textContent = items.length.toString();

        if (!items.length){
          itemsEl.innerHTML = "<div class='empty-text'>Aucun BrainRot en vente pour l'instant.</div>";
          return;
        }

        itemsEl.innerHTML = items.map(p => `
          <div class="item">
            <div>
              <div>${p.title || p.category || "Sans nom"}</div>
              <span class="cat">${p.category || "?"}</span>
            </div>
            <span class="price">${(Number(p.price_eur)||0).toFixed(2).replace(".", ",")} €</span>
          </div>
        `).join("");
      }catch(err){
        console.error("Erreur chargement items:", err);
        itemsEl.innerHTML = "<div class='empty-text'>Impossible de charger la liste (fonction Netlify products).</div>";
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msgEl.textContent = "";
      msgEl.className = "msg";
      submitBtn.disabled = true;

      const name = document.getElementById("name").value.trim();
      const category = document.getElementById("category").value.trim();
      const price = document.getElementById("price").value.trim();

      if (!currentImageDataUrl){
        msgEl.textContent = "Choisis d'abord une image.";
        msgEl.classList.add("error");
        submitBtn.disabled = false;
        return;
      }

      const payload = {
        name,
        category,
        price,
        image: currentImageDataUrl
      };

      try{
        const res = await fetch("/.netlify/functions/admin-products", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=>({}));

        if (res.ok && data.ok){
          msgEl.textContent = "BrainRot enregistré avec succès.";
          msgEl.classList.add("ok");
          form.reset();
          fileInfo.textContent = "Aucune image sélectionnée.";
          currentImageDataUrl = "";
          await loadItems();
        }else{
          console.error("Réponse erreur admin-products:", data);
          msgEl.textContent = "Erreur serveur. Vérifie la fonction admin-products sur Netlify.";
          msgEl.classList.add("error");
        }
      }catch(err){
        console.error("Erreur fetch admin-products:", err);
        msgEl.textContent = "Erreur serveur. Vérifie la fonction admin-products sur Netlify.";
        msgEl.classList.add("error");
      }finally{
        submitBtn.disabled = false;
      }
    });

    loadItems();
  </script>
</body>
</html>
